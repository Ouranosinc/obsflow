digraph Combined {
    rankdir=TB;
    labelloc=top;
    fontsize=16;

    node [shape=box style=filled fontname="Helvetica" fontsize=10];

    // ===== PCIC-Blend Nodes =====
    AHCCD [label="AHCCD\n(Adj. & Homog.\nCanadian Climate Data)", shape=parallelogram, fillcolor="#fff2cc"];
    GHCN [label="GHCN-Daily", shape=parallelogram, fillcolor="#fff2cc"];
    USHCN [label="USHCN-Daily", shape=parallelogram, fillcolor="#fff2cc"];
    CR20 [label="20CR2 Reanalysis\n(Virtual Stations)", shape=parallelogram, fillcolor="#fff2cc"];
    ClimateWNA [label="ClimateWNA Normals\n(Elev., Lapse Rate,\nDist. to Coast)", shape=parallelogram, fillcolor="#ffe599"];
    ECCC_Raw_Data [label="ECCC National Climate\nData Archive\n(Raw Daily Precip.)", shape=parallelogram, fillcolor="#fff2cc"];

    ANUSPLIN [label="ANUSPLIN\n(Thin-Plate Spline Interp.)", fillcolor="#fce5cd"];
    TPS_PNWNA [label="Thin-Plate Splines\n(PNWNAmet)", fillcolor="#fce5cd"];
    TPS_NRCAN [label="Thin-Plate Splines\n(NRCANmet V2)", fillcolor="#fce5cd"];
    PREP_ADJ [label="Precip Adjustments\n• SWE Conversion\n• Undercatch/Wetting Loss\n• Trace Handling\n• Data Flag Treatment\n(Output: AdjDlyRS dataset)", fillcolor="#fce5cd"];

    PNWNAmet [label="PNWNAmet\nDomain: 40–72°N, 169–101°W\nResolution: 0.0625° (~6 km)\nTimestep: Daily", fillcolor="#c9daf8"];
    NRCAN_V2 [label="NRCANmet V2\nDomain: Canada\nResolution: 0.0833° (~10 km)\nTimestep: Daily", fillcolor="#c9daf8"];
    NRCAN_ADJ [label="NRCANmet-Adjusted\nDomain: Canada\nResolution: 10 km (daily/pentad)\n2 km (monthly)\nTimestep: Daily/Pentad/Monthly", fillcolor="#c9daf8"];

    Blend [label="Blending / Transition Zone\nSigmoidal weighting across Rockies\nWest ↔ East merge by variable", fillcolor="#fce5cd", shape=box];

    PCIC [label="PCIC-Blend\n\nDomain: Northwestern North America\n(40–72°N, 169–101°W)\nGrid: Native inputs blended\nTimestep: Daily\nVars: pr, tasmax, tasmin\nMethod: Variable-specific blend", fillcolor="#b6d7a8", shape=hexagon];

    // ===== Reconstruction Nodes =====
    ERA5 [label="ERA5\n(31 km, 4D-Var reanalysis)", fillcolor="#cfe2f3"];
    MERRA2 [label="MERRA-2", fillcolor="#cfe2f3"];
    JRA55 [label="JRA-55", fillcolor="#cfe2f3"];
    ERAInt [label="ERA-Interim", fillcolor="#cfe2f3"];

    SYNOP [label="SYNOP\n(Surface Obs)", shape=parallelogram, fillcolor="#fff2cc"];
    METAR [label="METAR\n(Aviation Obs)", shape=parallelogram, fillcolor="#fff2cc"];
    SWOB [label="SWOB\n(Snow Obs)", shape=parallelogram, fillcolor="#fff2cc"];
    AdjDlyRS [label="AdjDlyRS\n(Adjusted Daily Rain/Snow)", shape=parallelogram, fillcolor="#fff2cc"];
    SCDNA [label="SCDNA\n24.6k Precip + 19.6k Temp\nSerially Complete Dataset", shape=parallelogram, fillcolor="#fff2cc"];

    SHIP [label="SHIP\n(Marine Obs)", shape=parallelogram, fillcolor="#fff2cc"];
    PILOT [label="PILOT\n", shape=parallelogram, fillcolor="#fff2cc"];
    AIREP [label="AIREP\n(Aircraft Obs)", shape=parallelogram, fillcolor="#fff2cc"];
    TEMP [label="TEMP\n(Radiosondes)", shape=parallelogram, fillcolor="#fff2cc"];
    GNSS [label="GNSS-RO\n(Satellite Occultation)", shape=parallelogram, fillcolor="#fff2cc"];
    SAT [label="Satellite Radiances\n(AMSU, IASI, etc.)", shape=parallelogram, fillcolor="#fff2cc"];

    GRDC [label="GRDC\nStreamflow", shape=parallelogram, fillcolor="#ffe599"];
    USGS [label="USGS\nStreamflow", shape=parallelogram, fillcolor="#ffe599"];
    HYDAT [label="HYDAT\nStreamflow (Canada)", shape=parallelogram, fillcolor="#ffe599"];
    CHELSA [label="CHELSA V1.2\nClimatological Bias Corr.", shape=parallelogram, fillcolor="#ffe599"];
    PBCOR [label="PBCOR\nDaily Bias Corr. from Streamflow", shape=parallelogram, fillcolor="#ffe599"];

    Static [label="Static Inputs\n• GLOBCOVER\n• MODIS albedo & LAI\n• FAO Soil\n• GLCC Land Cover", shape=parallelogram, fillcolor="#fff2cc"];

    CaPA [label="CaPA\n(Precip Assimilation)", shape=parallelogram, fillcolor="#f9cb9c"];
    CaLDAS [label="CaLDAS\n(Soil Moisture/Snow DA)", shape=parallelogram, fillcolor="#f9cb9c"];

    GDRS [label="GDRS\nGlobal Dynamical Downscaling", fillcolor="#c9daf8"];
    RDRS [label="RDRS\nRegional Downscaling", fillcolor="#c9daf8"];
    BMA [label="Bayesian Model Averaging\n(Merged Reanalyses)", fillcolor="#fce5cd"];
    OI [label="Optimal Interpolation\n(Station + Reanalysis)", fillcolor="#fce5cd"];
    CHTESSEL [label="CHTESSEL\nLand Surface Model", fillcolor="#d9ead3"];
    GEM [label="GEM\nAtmospheric Model", fillcolor="#d9d2e9"];
    ISBA [label="ISBA\nSurface Scheme", fillcolor="#d9d2e9"];
    StatGen [label="Statistical Generator\n(Parametric/Box-Cox, etc.)", fillcolor="#ead1dc"];

    ERA5_Land [label="ERA5-Land\n\nDomain: Global land\nResolution: 9 km\nTimestep: Hourly\nPeriod: 1981–present\nAssimilation: No\nModel: Offline\nEnsemble: Deterministic\nOutputs: soil temp/moisture, runoff, snow, fluxes", shape=hexagon, fillcolor="#b6d7a8"];

    CaSR [label="CaSR (RDRS v2.1)\n\nDomain: North America\nResolution: 10 km\nTimestep: Hourly\nPeriod: 1980–2018\nAssimilation: CaPA (precip), CaLDAS (soil/snow)\nModel: Online\nEnsemble: Deterministic\nOutputs: precip, snow, soil state, energy fluxes", shape=hexagon, fillcolor="#9fc5e8"];

    EMDNA [label="EMDNA\n\nDomain: Canada + border regions\nResolution: 0.1° (~10 km)\nTimestep: Daily\nPeriod: 1979–2018\nAssimilation: BMA + OI\nModel: Offline\nEnsemble: 100 members\nOutputs: Precip, Tmean, Trange, PoP", shape=hexagon, fillcolor="#f9cb9c"];

    // ===== PCIC-Blend Connections =====
    ECCC_Raw_Data -> PREP_ADJ;
    AHCCD -> PNWNAmet;
    USHCN -> PNWNAmet;
    GHCN -> PNWNAmet;
    CR20 -> PNWNAmet [style=dashed, label="virtual stations"];
    AHCCD -> NRCAN_V2;
    ClimateWNA -> PNWNAmet;
    ClimateWNA -> NRCAN_V2;
    PREP_ADJ -> ANUSPLIN;
    ANUSPLIN -> NRCAN_ADJ;
    TPS_PNWNA -> PNWNAmet;
    TPS_NRCAN -> NRCAN_V2;
    PNWNAmet -> Blend [label="pr, tasmax, tasmin\n(west)"];
    NRCAN_ADJ -> Blend [label="pr (east)"];
    NRCAN_V2 -> Blend [label="tasmax, tasmin (east)"];
    Blend -> PCIC;

    { rank=same; AHCCD; GHCN; USHCN; CR20; ClimateWNA; ECCC_Raw_Data }
    { rank=same; ANUSPLIN; TPS_PNWNA; TPS_NRCAN; PREP_ADJ }
    { rank=same; PNWNAmet; NRCAN_V2; NRCAN_ADJ }
    { rank=same; Blend }

    // ===== Reconstruction Connections =====
    RDRS -> CaPA [label="Background precip fields", style=dashed];
    RDRS -> CaLDAS [label="Regional forcing", style=dashed];
    CaLDAS -> RDRS [label="Soil/snow states", style=dashed];
    ERA5 -> ERA5_Land [label="Downscaled forcing", style=solid];
    Static -> ERA5_Land [label="Surface params", style=dashed];
    CHTESSEL -> ERA5_Land [label="Land model", style=solid];

    ERAInt -> GDRS [label="Initial forcing", style=solid];
    GDRS -> RDRS [label="Regional model", style=solid];
    RDRS -> GEM [style=solid];
    RDRS -> ISBA [style=solid];
    GEM -> CaSR [label="Atmos model", style=solid];
    ISBA -> CaSR [label="Surf model", style=solid];
    CaPA -> CaSR [label="Precip assimilation", style=dashed];
    CaLDAS -> CaSR [label="Soil/snow DA", style=dashed];

    ERA5 -> BMA [style=dashed];
    MERRA2 -> BMA [style=dashed];
    JRA55 -> BMA [style=dashed];
    SCDNA -> OI [label="Regression input", style=dashed];
    BMA -> OI [label="Merged background", style=solid];
    OI -> CHELSA [label="Daily precip", style=solid];
    CHELSA -> EMDNA [label="Bias-corrected precip", style=solid];
    GRDC -> PBCOR [style=dashed];
    HYDAT -> PBCOR [style=dashed];
    USGS -> PBCOR [style=dashed];
    PBCOR -> EMDNA [label="Daily correction", style=solid];
    OI -> StatGen [label="PDF params (µ, σ, PoP)", style=solid];
    StatGen -> EMDNA [label="100 ensemble members", style=solid];

    SYNOP -> CaPA [style=dashed];
    METAR -> CaPA [style=dashed];
    SWOB -> CaLDAS [style=dashed];
    AdjDlyRS -> CaPA [style=dashed];
    SCDNA -> EMDNA [style=solid];

    SYNOP -> ERA5 [style=dashed];
    SHIP -> ERA5 [style=dashed];
    PILOT -> ERA5 [style=dashed];
    AIREP -> ERA5 [style=dashed];
    TEMP -> ERA5 [style=dashed];
    GNSS -> ERA5 [style=dashed];
    SAT -> ERA5 [style=dashed];

    { rank=same; GRDC; USGS; HYDAT }
    { rank=same; SCDNA; Static; CaPA; CaLDAS }
    { rank=same; CHELSA; PBCOR }
    { rank=same; GDRS; BMA }
    { rank=same; RDRS; OI }
    { rank=same; CHTESSEL; GEM; ISBA; StatGen }
    { rank=same; ERA5_Land; CaSR; EMDNA; PCIC }
}
